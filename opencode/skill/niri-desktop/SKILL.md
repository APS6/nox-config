---
name: niri-desktop
description: Configure CachyOS Niri desktop - themes, keybindings, waybar, walker, and related components
license: MIT
compatibility: opencode
metadata:
  system: cachyos
  compositor: niri
  shell: fish
---

# Niri Desktop Configuration Skill

This skill provides knowledge for configuring the CachyOS + Niri Wayland desktop environment for user `aps`.

## System Overview

- **OS**: CachyOS (Arch-based)
- **Compositor**: Niri (scrolling tiling Wayland compositor)
- **Shell**: Fish with Starship prompt
- **Terminal**: Ghostty
- **Launcher**: Walker
- **Bar**: Waybar
- **Notifications**: Mako
- **Lock Screen**: gtklock
- **Wallpaper**: swww

## Key Config Locations

| Component | Config Path |
|-----------|-------------|
| Niri | `~/.config/niri/config.kdl` |
| Ghostty | `~/.config/ghostty/config` (generated) |
| Walker | `~/.config/walker/config.toml` |
| Waybar | `~/.config/waybar/config` + `style.css` (generated) |
| Fish | `~/.config/fish/config.fish` |
| Starship | `~/.config/starship.toml` (generated) |
| Mako | `~/.config/mako/config` (generated) |
| gtklock | `~/.config/gtklock/config.ini` + `style.css` (generated) |
| SwayOSD | `~/.config/swayosd/style.css` (generated) |
| Themes | `~/.config/themes/` |

## Theme System

### Structure

```
~/.config/themes/
├── themes/           # Theme definitions
│   ├── catppuccin/
│   │   ├── colors.conf    # Color variables (sourced by bash)
│   │   ├── wallpapers/    # Theme wallpapers
│   │   ├── zed.json       # Zed editor theme (optional)
│   │   └── btop.theme     # btop theme (optional)
│   ├── tokyo-night/
│   ├── nord/
│   ├── everforest/
│   ├── gruvbox/
│   ├── kanagawa/
│   ├── matte-black/
│   ├── hackerman/
│   └── ethereal/
├── templates/        # Templates with ${variable} placeholders
│   ├── ghostty.conf
│   ├── walker.css
│   ├── waybar.css
│   ├── swayosd.css
│   ├── starship.toml
│   ├── gtklock.css
│   └── mako.conf
├── theme-switch.sh   # Main theme switcher script
├── theme-picker.sh   # Walker integration for GUI picker
├── current           # Stores current theme name
└── wallpaper         # Symlink to current wallpaper
```

### Color Variables (colors.conf)

Each theme's `colors.conf` must define these variables:

```bash
name="Theme Display Name"
ghostty_theme="Builtin Theme Name"  # Optional, uses palette if not set

# Core colors
bg="#1e1e2e"          # Main background
bg_light="#313244"    # Slightly lighter background
bg_lighter="#45475a"  # Even lighter (borders, inactive)
fg="#cdd6f4"          # Main foreground
fg_dim="#7f849c"      # Dimmed text
accent="#b4befe"      # Accent color (focus rings, highlights)
border="#c6d0f5"      # Border color

# Semantic colors
red="#f38ba8"
green="#a6e3a1"
yellow="#f9e2af"
blue="#89b4fa"
magenta="#f5c2e7"
cyan="#94e2d5"

# Terminal specific
cursor="#f5e0dc"
selection="#f5e0dc"

# Optional: full 16-color palette (palette_0 through palette_15)
```

### Using the Theme Switcher

```bash
# Switch theme via CLI
~/.config/themes/theme-switch.sh catppuccin

# Available themes
~/.config/themes/theme-switch.sh  # Shows list when no arg

# GUI picker (bound to MOD+Shift+T)
~/.config/themes/theme-picker.sh
```

### What Theme Switcher Updates

1. **Ghostty** - Uses built-in theme or generates custom palette
2. **Walker** - CSS template with color variables
3. **Waybar** - CSS template (transparent window, styled box)
4. **SwayOSD** - CSS for volume/brightness OSD
5. **Mako** - Notification daemon config
6. **Starship** - Accent color in prompt
7. **btop** - Copies theme file if present
8. **gtklock** - Lock screen CSS + wallpaper path
9. **Niri** - Updates focus-ring colors and overview backdrop-color
10. **Zed** - Copies theme JSON and updates settings.json
11. **Wallpaper** - Sets via swww with transition animation

### Adding a New Theme

1. Create directory: `~/.config/themes/themes/<name>/`
2. Create `colors.conf` with all required variables
3. Add wallpapers to `wallpapers/` subdirectory
4. Optionally add `zed.json` and `btop.theme`
5. Test: `~/.config/themes/theme-switch.sh <name>`

### Adding a New App to Theme Switcher

1. Create template in `~/.config/themes/templates/<app>.ext`
   - Use `${variable}` syntax for color substitution
2. Edit `~/.config/themes/theme-switch.sh`:
   - Add section to generate config using `envsubst`
   - Add reload command if app supports it
3. Update `.gitignore` to exclude generated file

## Files NOT to Edit Directly

These files are **generated by theme-switch.sh**. Edit the templates instead:

| Generated File | Edit This Instead |
|----------------|-------------------|
| `ghostty/config` | `themes/templates/ghostty.conf` |
| `walker/themes/default/style.css` | `themes/templates/walker.css` |
| `waybar/style.css` | `themes/templates/waybar.css` |
| `swayosd/style.css` | `themes/templates/swayosd.css` |
| `mako/config` | `themes/templates/mako.conf` |
| `gtklock/style.css` | `themes/templates/gtklock.css` |
| `starship.toml` | `themes/templates/starship.toml` |

Also, `niri/config.kdl` has colors updated in-place by sed.

## Common Tasks

### Change a keybinding

Edit `~/.config/niri/config.kdl` in the `binds { }` section.

### Add a window rule

```kdl
window-rule {
    match app-id=r#"^app-id-regex$"#
    open-maximized true  // or open-floating, etc.
}
```

### Adjust gaps or focus ring

Edit `layout { }` section in niri config.

### Add new app to waybar

1. Edit `~/.config/waybar/modules.json` for module definition
2. Edit `~/.config/waybar/config` to add to modules-left/center/right
3. Edit `~/.config/themes/templates/waybar.css` for styling

### Reload after changes

- **Niri**: Changes auto-reload (shows notification)
- **Waybar**: `pkill waybar && waybar &`
- **Walker**: `pkill walker && walker --gapplication-service &`
- **Mako**: `makoctl reload`
- **Or just run theme-switch.sh** which reloads all

## Login Manager (greetd + tuigreet)

Display manager uses greetd with tuigreet in a minimal sway session.

**Config**: `/etc/greetd/config.toml`
```toml
[terminal]
vt = 1

[default_session]
command = "sway --config /etc/greetd/sway-config"
user = "greeter"
```

**Sway config for greeter**: `/etc/greetd/sway-config`
```
output eDP-1 enable
output * disable
output eDP-1 enable

exec "foot --fullscreen --font='JetBrainsMono Nerd Font:size=14' tuigreet --remember --remember-session --asterisks --time --width 55 --container-padding 2 --sessions /usr/share/wayland-sessions --cmd niri-session; swaymsg exit"
```

tuigreet options:
- `--remember` - Remember last user
- `--remember-session` - Remember last session
- `--asterisks` - Show asterisks for password
- `--time` - Show current time
- `--cmd niri-session` - Launch niri via session wrapper

## Idle & Lock (swayidle + gtklock)

**Config**: `~/.config/swayidle/config`
```
# Lock after 5 minutes idle
timeout 300 'gtklock -d'

# Turn off monitors after 10 minutes idle
timeout 600 'niri msg action power-off-monitors'

# Lock before sleep/suspend
before-sleep 'gtklock -d'
```

**Toggle script**: `~/.config/swayidle/toggle.sh`
- Bound to `MOD+Ctrl+I`
- Toggles swayidle on/off with notification

**gtklock**: Minimal lock screen showing only password input, themed via CSS.

## Power Menu

Walker-based power menu at `~/.config/walker/power-menu.sh`:
- Bound to `MOD+Escape`
- Options: Lock, Suspend, Logout, Reboot, Shutdown

## Fingerprint Auth (fprintd)

Fingerprint reader configured for sudo authentication.

**PAM config** (`/etc/pam.d/sudo`):
```
auth       sufficient   pam_fprintd.so
auth       include      system-auth
...
```

Enroll fingerprints: `fprintd-enroll`

## Snapper (Btrfs Snapshots)

CachyOS uses snapper for btrfs snapshots with limine bootloader integration.

**Config**: `/etc/snapper/configs/root`

Key settings:
- `NUMBER_LIMIT="50"` - Keep up to 50 numbered snapshots
- `NUMBER_LIMIT_IMPORTANT="15"` - Keep 15 important snapshots
- `TIMELINE_CREATE="no"` - No automatic timeline snapshots
- `EMPTY_PRE_POST_CLEANUP="yes"` - Clean empty pre/post pairs

**Systemd services**:
- `snapper-cleanup.timer` - Periodic cleanup
- `limine-snapper-sync.service` - Syncs snapshots to bootloader

**Commands**:
```bash
# List snapshots
snapper list

# Create manual snapshot
snapper create -d "description"

# Create pre/post pair (for system changes)
snapper create -t pre -p  # returns number
# ... make changes ...
snapper create -t post --pre-number=<num>

# Rollback (via bootloader menu or)
snapper rollback <num>
```

## Git Repository

The `.config` directory is tracked at `github.com/APS6/nox-config`.

## User Preferences

- Font: JetBrains Mono Nerd Font
- No emojis in configs unless requested
- Minimal/clean aesthetic
- Prefers AI to make config changes rather than manual editing
